# Copyright 2021 Canonical Ltd.
# See LICENSE file for licensing details.

# For a complete list of supported options, see:
# https://discourse.charmhub.io/t/charm-metadata-v2/3674/15

name: loki-k8s

assumes:
  - k8s-api

  # Juju 3.0.3+ needed for secrets and open-port
  - juju >= 3.0.3

summary: |
  Loki is a set of components that can be composed into a fully featured logging stack.

description: |
  Loki for Kubernetes cluster

maintainers:
    - Jose Mass√≥n <jose.masson@canonical.com>

website: https://charmhub.io/loki-k8s
source: https://github.com/canonical/loki-k8s-operator
issues: https://github.com/canonical/loki-k8s-operator/issues
docs: https://discourse.charmhub.io/t/loki-k8s-docs-index/5228

containers:
  loki:
    resource: loki-image
    mounts:
      - storage: active-index-directory
        location: /loki/boltdb-shipper-active
      - storage: loki-chunks
        location: /loki/chunks
      - storage: loki-wal
        location: /loki/wal
      - storage: tsdb-index
        location: /loki/tsdb-index
storage:
  active-index-directory:
    type: filesystem
    description: Mount point in which Loki will store index
  tsdb-index:
    type: filesystem
    description: Mount point in which Loki will store TSDB indices
  loki-chunks:
    type: filesystem
    description: Mount point in which Loki will store chunks (objects)
  loki-wal:
    type: filesystem
    description: Mount point in which Loki will store write ahead logs


provides:
  logging:
    interface: loki_push_api
  grafana-source:
    interface: grafana_datasource
    optional: true
  metrics-endpoint:
    interface: prometheus_scrape
  grafana-dashboard:
    interface: grafana_dashboard

requires:
  alertmanager:
    interface: alertmanager_dispatch
  ingress:
    interface: ingress_per_unit
    limit: 1 # Since this is the ingress there is no point in having more than one.
  certificates:
    interface: tls-certificates
    limit: 1
    description: |
      Certificate and key files for the loki server.
  catalogue:
    interface: catalogue
  tracing:
    interface: tracing
    limit: 1

peers:
  replicas:
    interface: loki_replica

resources:
  loki-image:
    type: oci-image
    description: Loki OCI image
    #upstream-source: ghcr.io/canonical/loki:2.7.4
    upstream-source: docker.io/ubuntu/loki:2-22.04
